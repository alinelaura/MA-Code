---
title: "Masterthesis script"
author: "Aline Laura Metzler"
date: "5/26/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


wefqwef
```{r}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(forcats)
library(ggplot2)
```

# Masterarbeit Script
 

### Deskriptive Analysis

Data is read and prepared in separate file. The variable for the type of voter is created by filtering individuals that lived in the same community for at least ten consecutive votes. For each individual the 10 most recent votes were selected. This allows for the classification of these individuals into "never voters" (0-1 participation), "selective voters" (2-8 participation) and "always voters" (9-10 participation). 

```{r}
setwd("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/")
data <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/data.csv", encoding = "UTF-8") %>% 
  mutate(beteiligt = as.factor(beteiligt)) %>%
  mutate(beteiligt = fct_relevel(beteiligt, c("keine Stimmbeteiligung", "mit Stimmbeteiligung"))) %>% 
   mutate(alter_c = fct_relevel(alter_c, c("18-30-Jährige","31-45-Jährige","46-60-Jährige","61-75-Jährige","Über 75-Jährige")),
         sex = fct_relevel(sex, c("Mann", "Frau")),
         konfession_c = fct_relevel(konfession_c, c("Andere/keine Konfession", "Christliche Konfession")),
         residenz10 = fct_relevel(residenz10, c("0-10 Jahre", "Mehr als 10 Jahre")),
         zugezogen = fct_relevel(zugezogen, c("In CH geboren","CH zugezogen")),
         mEinkommen_c = fct_relevel(mEinkommen_c, c("0-25'000.-","25'000-55'000.-","55'000-90'000.-","Über 90'000.-")),
         Vermoegen_c = fct_relevel(Vermoegen_c, c("0-8'000.-","8'000-60'000.-","60'000-185'000.-","Über 185'000.-")))

data_mlogit <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/data_mlogit.csv", encoding = "UTF-8") %>% 
  mutate(vote_type = as.factor(vote_type),
         vote_type_det = as.factor(vote_type_det)) %>%
  mutate(vote_type =  fct_relevel(vote_type, c("never voter", "selective voter", "always voter")),
         vote_type_det =  fct_relevel(vote_type_det, c("never voter","seldom voter","occasional voter","frequent voter","always voter"))) %>% 
   mutate(alter_c = fct_relevel(alter_c, c("18-30-Jährige","31-45-Jährige","46-60-Jährige","61-75-Jährige","Über 75-Jährige")),
         sex = fct_relevel(sex, c("Mann", "Frau")),
         konfession_c = fct_relevel(konfession_c, c("Andere/keine Konfession", "Christliche Konfession")),
         residenz10 = fct_relevel(residenz10, c("0-10 Jahre", "Mehr als 10 Jahre")),
         zugezogen = fct_relevel(zugezogen, c("In CH geboren","CH zugezogen")),
         mEinkommen_c = fct_relevel(mEinkommen_c, c("0-25'000.-","25'000-55'000.-","55'000-90'000.-","Über 90'000.-")),
         Vermoegen_c = fct_relevel(Vermoegen_c, c("0-8'000.-","8'000-60'000.-","60'000-185'000.-","Über 185'000.-")))


data_mlogit15 <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/data_mlogit15.csv", encoding = "UTF-8")%>% 
  mutate(vote_type = as.factor(vote_type),
         vote_type_det = as.factor(vote_type_det)) %>%
  mutate(vote_type =  fct_relevel(vote_type, c("never voter", "selective voter", "always voter")),
         vote_type_det =  fct_relevel(vote_type_det, c("never voter","seldom voter","occasional voter","frequent voter","always voter"))) %>% 
   mutate(alter_c = fct_relevel(alter_c, c("18-30-Jährige","31-45-Jährige","46-60-Jährige","61-75-Jährige","Über 75-Jährige")),
         sex = fct_relevel(sex, c("Mann", "Frau")),
         konfession_c = fct_relevel(konfession_c, c("Andere/keine Konfession", "Christliche Konfession")),
         residenz10 = fct_relevel(residenz10, c("0-10 Jahre", "Mehr als 10 Jahre")),
         zugezogen = fct_relevel(zugezogen, c("In CH geboren","CH zugezogen")),
         mEinkommen_c = fct_relevel(mEinkommen_c, c("0-25'000.-","25'000-55'000.-","55'000-90'000.-","Über 90'000.-")),
         Vermoegen_c = fct_relevel(Vermoegen_c, c("0-8'000.-","8'000-60'000.-","60'000-185'000.-","Über 185'000.-")))


# source("MA_adminDataPreparation.R", local = knitr::knit_global())
```

### Distribution of voter types
Hier folgt dann noch eine schöne Tabelle, evtl. mit Kummulierter Häufigkeit.

```{r}
summary(data_mlogit$vote_type)

summary(data_mlogit$vote_type_det)
```

### Scatter Plot Einkommen und Anz. Teilnahmen bei 10 Abstimmungen

H1A/B

```{r}
summary(data_mlogit$massgebendesEinkommen_imputed)
summary(data_mlogit$anz_teilnahme)


plot_scatter <- data_mlogit %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = massgebendesEinkommen_imputed, y = anz_teilnahme)) +
  # geom_bin2d(bins = 10)
  geom_point() +
  geom_jitter() +
  geom_smooth() +
  theme_minimal()
plot_scatter

plot_scatter_age <- data_mlogit %>% 
  filter(!is.na(alter_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = massgebendesEinkommen_imputed, y = anz_teilnahme)) +
  geom_point() +
  geom_jitter() +
  geom_smooth() +
  facet_wrap(~ alter_c) +
  theme_minimal()
plot_scatter_age

plot_scatter_sex <- data_mlogit %>% 
  filter(!is.na(sex_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = massgebendesEinkommen_imputed, y = anz_teilnahme)) +
  geom_point() +
  geom_jitter() +
  geom_smooth() +
  facet_wrap(~ sex_c) +
  theme_minimal()
plot_scatter_sex


```

### Multinomial Logit Model
Was ist der Unterschied zwischen mlogit() und multinom()? Weshalb funktioniert mlogit() nicht und multinom() schon?

H1.1A/B

```{r}
# library(mlogit)
#
# # Generating the Person-Choice Matrix
# data_mlogitprep <- as.data.frame(data_mlogit) %>% 
#   select(vote_type, alter_c, sex_c, konfession_c, residenz10, zugezogen, mEinkommen_c, Vermoegen_c) %>% 
#   na.omit()
# data_mlogit.pc <- mlogit.data(data_mlogitprep,
#                               varying = 2:8,
#                               choice = "vote_type",
#                               shape = "wide",
#                               sep = "_")
# head(data_mlogit.pc)
# 
# mlogit.fit <- mlogit(vote_type ~ 0 | alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
#                           shape = "long",
#                           data = data_mlogit.pc)

library(nnet)
library(stargazer)
mlogit <- multinom(vote_type ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = data_mlogit)
stargazer(mlogit, type = "text")
```


```{r}
mlogit_det <- multinom(vote_type_det ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = data_mlogit15)
stargazer(mlogit_det, type = "text")
```

### Effect of age on political participation for different income quartiles

```{r}
plot_scatter_ageincome <- data_mlogit %>% 
  filter(!is.na(mEinkommen_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = alter_v, y = anz_teilnahme)) +
  geom_point() +
  geom_jitter() +
  geom_smooth() +
  facet_wrap(~ mEinkommen_c) +
  theme_minimal()
plot_scatter_ageincome


plot_scatter_agevermoegen <- data_mlogit %>% 
  filter(!is.na(mEinkommen_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = alter_v, y = anz_teilnahme)) +
  # geom_point() +
  # geom_jitter() +
  geom_smooth() +
  facet_wrap(~ Vermoegen_c) +
  theme_minimal()
plot_scatter_agevermoegen
```

### Effect of jumps in income/wealth

Identify the jumps

->Since we only have income per year -->participation as share (sum(partic)/sum(all_votes))
-->then look for jumps in yearly income
-->compare share of participation before and after


Possible distinctions:
Four graphs, corresponding to three distinct events:
1)	From no income to some income
2)	From some income to no income
3)	From some income to less than 50% of that income
4)	From some income to less than 75% of that income



```{r}
library(data.table) 

# get aggregated data by year for respondents
data_year <- data %>% 
  mutate(anz_teilnahme = case_when(
    beteiligt == "mit Stimmbeteiligung" ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(anz_abstimmungen = case_when(
    beteiligt == "mit Stimmbeteiligung" ~ 1,
    beteiligt == "keine Stimmbeteiligung" ~ 1
  )) %>% 
  group_by(id_ek, abstimmungsjahr) %>%
  summarise(anz_teilnahme = sum(anz_teilnahme),
            anz_abstimmungen = sum(anz_abstimmungen),
            share_teilnahme = anz_teilnahme/anz_abstimmungen,
            sex = last(sex_imp),
            alter = mean(alter_v, na.rm=TRUE),
            konfession = last(konfession_imp),
            residenz = mean(residenz_imp, na.rm=TRUE),
            zugezogen = last(zugezogen),
            einkommen = mean(massgebendesEinkommen_imputed, na.rm=TRUE),
            vermoegen = mean(reinvermoegen_imputed, na.rm=TRUE)
            ) %>% 
  distinct() %>% 
  ungroup() 

# Identify individuals with bigger changes in income or wealth
data_year <- data_year %>% 
  group_by(id_ek) %>% 
  # calculate change compared to previous year
  mutate(change_eink = 100 * (einkommen - lag(einkommen, default = NA))/lag(einkommen, default = NA)) %>% 
  mutate(change_verm = 100 * (vermoegen - lag(vermoegen, default = NA))/lag(vermoegen, default = NA)) %>% 
  # Identify big changes in income/wealth
  # TODO: when is change considered to be big? (after 30% change?)
  mutate(bigchange_eink = case_when(
    change_eink >= 20 ~ 5,
    change_eink >= 50 ~ 1,
    change_eink <= -50 ~ 2,
    TRUE ~ 0
  )) %>% 
  mutate(bigchange_verm = case_when(
    change_verm >= 20 ~ 5,
    change_verm >= 50 ~ 1,
    change_verm <= -50 ~ 2,
    TRUE ~ 0
  )) %>% 
  # create variable to detect individuals with treatment (i.e. big income drop)
  # Only valid when also wealth dropped (otherwise just income shift)
  mutate(treat_less50income = case_when(
    bigchange_eink == 2 & bigchange_verm %in% c(0, 5) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less50wealth = case_when(
    bigchange_verm == 2 & bigchange_eink %in% c(0, 5) ~ 1,
    TRUE ~ 0
  )) 


data_year <- data_year %>%
  # for multiple income/wealth shocks only take first one
  group_by(id_ek) %>%
  mutate(inc_change = as.numeric(rle(treat_less50income)$lengths %>% {rep(seq(length(.)), .)})) %>% 
  mutate(wealth_change = as.numeric(rle(treat_less50wealth)$lengths %>% {rep(seq(length(.)), .)})) %>% 
  ungroup() %>% 
  mutate(inc_change = case_when(
    inc_change > 2 ~ 3,
    TRUE ~ inc_change
  )) %>% 
  mutate(wealth_change = case_when(
    wealth_change > 2 ~ 3,
    TRUE ~ wealth_change
  )) %>% 
  mutate(treatment_year_inc = case_when(
    inc_change == 2 ~ abstimmungsjahr,
    TRUE ~ NA_integer_
  )) %>% 
  mutate(treatment_year_wealth = case_when(
    wealth_change == 2 ~ abstimmungsjahr,
    TRUE ~ NA_integer_
  )) %>% 
  group_by(id_ek) %>% 
  fill(treatment_year_inc, .direction = "updown") %>% 
  fill(treatment_year_wealth, .direction = "updown") %>% 
  mutate(treat_less50income = case_when(
    !is.na(treatment_year_inc) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less50wealth = case_when(
    !is.na(treatment_year_wealth) ~ 1,
    TRUE ~ 0
  )) %>% 
  # create var years from/to treatment. For the never-treated (i.e. control) units,
  # we'll set the "time_to_treatment" value at 0 for the middle year.
  mutate(treatment_year_inc = 
           ifelse(is.na(treatment_year_inc), round(mean(abstimmungsjahr)), treatment_year_inc)) %>% 
  mutate(treatment_year_wealth = 
           ifelse(is.na(treatment_year_wealth), round(mean(abstimmungsjahr)), treatment_year_wealth)) %>% 
  mutate(time_to_treat_inc = ifelse(treat_less50income == 1, (abstimmungsjahr - treatment_year_inc), 0)) %>% 
  mutate(time_to_treat_wealth = ifelse(treat_less50wealth == 1, (abstimmungsjahr - treatment_year_wealth), 0))
  

```


### Difference-in-Differences Event Study 
Help: https://lost-stats.github.io/Model_Estimation/Research_Design/event_study.html



```{r}
library(fixest) 

# income shocks
mod_twfe = feols(share_teilnahme ~ i(time_to_treat_inc, treat_less50income, ref = -1) + ## key interaction: time × treatment status
		  alter + einkommen |               ## Other controls
		  id_ek + abstimmungsjahr,                  ## FEs
		 cluster = ~id_ek,                          ## Clustered SEs
		 data = data_year)


iplot(mod_twfe, 
      xlab = 'Time to treatment',
      main = 'Event-Study of the Effects of Neg. Income Shocks on Voter Turnout (TWFE)')


# wealth shocks
mod_twfe2 = feols(share_teilnahme ~ i(time_to_treat_wealth, treat_less50income, ref = -1) + ## key interaction: time × treatment status
		  alter + vermoegen |               ## Other controls
		  id_ek + abstimmungsjahr,                  ## FEs
		 cluster = ~id_ek,                          ## Clustered SEs
		 data = data_year)


iplot(mod_twfe2, 
      xlab = 'Time to treatment',
      main = 'Event-Study of the Effects of Neg. Wealth Shocks on Voter Turnout (TWFE)')
```



In Figure 2, we show the curvilinear effects of income on turnout graphically. To do so, we estimate the impact of economic status, as measured by changes in a voter’s relative position in the income distribution (in deciles) from one election-year to the next. For example, the left-most coefficient shows that moving from the lowest 10% to the 10%–20%—a difference of about € 9,000— increases voter turnout by 2.2 p.p., on average. Climbing up each step of the income ladder leads to higher voter turnout until the median (about € 21,500), where the impact on participation compared to the bottom decile is about 4.2 p.p. Beyond that, the marginal effect of income appears to diminish toward 0.


```{r}

```


### Je geringer die empfundene Relevanz einer Abstimmung ist, desto grösser ist die Rolle, welche das Einkommen bei der Beteiligung am Urnengang spielt. 


```{r}
votes <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/votes_data_short.csv", encoding = "UTF-8")

# select votes with low/high importance (i.e. lowest/highest quartile of importance)
votes_lowimp <- votes %>% 
  filter(quantile(importance, 0.25) >= importance) %>% 
  select(datum, titel_kurz_d, jour, mois, annee, importance)
votes_highimp <- votes %>% 
  filter(quantile(importance, 0.75) <= importance) %>% 
  select(datum, titel_kurz_d, jour, mois, annee, importance)

# join with admin. data
turnout_lowimp <- votes_lowimp %>% 
  left_join(data, by = "datum")
turnout_highimp <- votes_highimp %>% 
  left_join(data, by = "datum")


# multinomial logit model
mlogit_lowimp <- multinom(beteiligt ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = turnout_lowimp)
mlogit_highimp <- multinom(beteiligt ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = turnout_highimp)

stargazer(mlogit_lowimp, mlogit_highimp, type = "text")
```

### Bei Abstimmungen mit einem grösseren Umverteilungsaspekt spielt das Einkommen eine grössere Rolle bei der Beteiligung am Urnengang.


```{r}

```

