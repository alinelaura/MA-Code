---
title: "Masterthesis script"
author: "Aline Laura Metzler"
date: "5/26/2022"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(forcats)
library(ggplot2)
```

# Masterarbeit Script
 

### Deskriptive Analysis

Data is read and prepared in separate file. The variable for the type of voter is created by filtering individuals that lived in the same community for at least ten consecutive votes. For each individual the 10 most recent votes were selected. This allows for the classification of these individuals into "never voters" (0-1 participation), "selective voters" (2-8 participation) and "always voters" (9-10 participation). 


TODO: initially I wanted to use source() to get the prepared data files, but it takes extremely long (much longer than 
running the scripts themselves).. Why? Is there a good alternative, since now I have to do the levels and 
factorization again, since the csv doesn't read them as programmed before...

```{r message=FALSE, warning=FALSE}
setwd("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/")

data <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/data.csv", encoding = "UTF-8") %>% 
  mutate(beteiligt = as.factor(beteiligt)) %>%
  mutate(beteiligt = fct_relevel(beteiligt, c("keine Stimmbeteiligung", "mit Stimmbeteiligung"))) %>% 
   mutate(alter_c = fct_relevel(alter_c, c("18-30-Jährige","31-45-Jährige","46-60-Jährige","61-75-Jährige","Über 75-Jährige")),
         sex = fct_relevel(sex, c("Mann", "Frau")),
         konfession_c = fct_relevel(konfession_c, c("Andere/keine Konfession", "Christliche Konfession")),
         residenz10 = fct_relevel(residenz10, c("0-10 Jahre", "Mehr als 10 Jahre")),
         zugezogen = fct_relevel(zugezogen, c("In CH geboren","CH zugezogen")),
         mEinkommen_c = fct_relevel(mEinkommen_c, c("0-25'000.-","25'000-55'000.-","55'000-90'000.-","Über 90'000.-")),
         Vermoegen_c = fct_relevel(Vermoegen_c, c("0-8'000.-","8'000-60'000.-","60'000-185'000.-","Über 185'000.-")))

data_mlogit <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/data_mlogit.csv", encoding = "UTF-8") %>% 
  mutate(vote_type = as.factor(vote_type),
         vote_type_det = as.factor(vote_type_det)) %>%
  mutate(vote_type =  fct_relevel(vote_type, c("never voter", "selective voter", "always voter")),
         vote_type_det =  fct_relevel(vote_type_det, c("never voter","seldom voter","occasional voter","frequent voter","always voter"))) %>% 
   mutate(alter_c = fct_relevel(alter_c, c("18-30-Jährige","31-45-Jährige","46-60-Jährige","61-75-Jährige","Über 75-Jährige")),
         sex = fct_relevel(sex, c("Mann", "Frau")),
         konfession_c = fct_relevel(konfession_c, c("Andere/keine Konfession", "Christliche Konfession")),
         residenz10 = fct_relevel(residenz10, c("0-10 Jahre", "Mehr als 10 Jahre")),
         zugezogen = fct_relevel(zugezogen, c("In CH geboren","CH zugezogen")),
         mEinkommen_c = fct_relevel(mEinkommen_c, c("0-25'000.-","25'000-55'000.-","55'000-90'000.-","Über 90'000.-")),
         Vermoegen_c = fct_relevel(Vermoegen_c, c("0-8'000.-","8'000-60'000.-","60'000-185'000.-","Über 185'000.-")))


data_mlogit15 <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/data_mlogit15.csv", encoding = "UTF-8")%>% 
  mutate(vote_type = as.factor(vote_type),
         vote_type_det = as.factor(vote_type_det)) %>%
  mutate(vote_type =  fct_relevel(vote_type, c("never voter", "selective voter", "always voter")),
         vote_type_det =  fct_relevel(vote_type_det, c("never voter","seldom voter","occasional voter","frequent voter","always voter"))) %>% 
   mutate(alter_c = fct_relevel(alter_c, c("18-30-Jährige","31-45-Jährige","46-60-Jährige","61-75-Jährige","Über 75-Jährige")),
         sex = fct_relevel(sex, c("Mann", "Frau")),
         konfession_c = fct_relevel(konfession_c, c("Andere/keine Konfession", "Christliche Konfession")),
         residenz10 = fct_relevel(residenz10, c("0-10 Jahre", "Mehr als 10 Jahre")),
         zugezogen = fct_relevel(zugezogen, c("In CH geboren","CH zugezogen")),
         mEinkommen_c = fct_relevel(mEinkommen_c, c("0-25'000.-","25'000-55'000.-","55'000-90'000.-","Über 90'000.-")),
         Vermoegen_c = fct_relevel(Vermoegen_c, c("0-8'000.-","8'000-60'000.-","60'000-185'000.-","Über 185'000.-")))


# source("MA_adminDataPreparation.R", local = knitr::knit_global())
```

### Distribution of voter types
Hier folgt dann noch eine schöne Tabelle, evtl. mit Kummulierter Haeufigkeit.

```{r message=FALSE, warning=FALSE}
summary(data_mlogit$vote_type)

summary(data_mlogit$vote_type_det)

data_table <- data_mlogit %>% 
  group_by(anz_teilnahme) %>% 
  summarise(count = n()) %>% 
  mutate(cum = cumsum(count)/sum(count)) %>% 
  rename(`Anzahl Teilnahme` = anz_teilnahme,
         `Anzahl Individuen` = count,
         `Kummulative Häufigkeit` = cum)


library(xtable)
table <- xtable(data_table)
# print(table)


library(reactable)
reactable(data_table, 
          defaultPageSize = 15,
          columns = list(`Kummulative Häufigkeit` = colDef(format = colFormat(percent = TRUE, digits = 1))))

```

### Scatter Plot Einkommen und Anz. Teilnahmen bei 10 Abstimmungen

H1A/B

```{r message=FALSE, warning=FALSE}
summary(data_mlogit$massgebendesEinkommen_imputed)
summary(data_mlogit$anz_teilnahme)


plot_scatter <- data_mlogit %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = massgebendesEinkommen_imputed, y = anz_teilnahme)) +
  # geom_bin2d(bins = 10)
  geom_jitter(alpha = 0.1) +
  geom_smooth() +
  theme_minimal()
plot_scatter

plot_scatter_age <- data_mlogit %>% 
  filter(!is.na(alter_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = massgebendesEinkommen_imputed, y = anz_teilnahme)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth() +
  facet_wrap(~ alter_c) +
  theme_minimal()
plot_scatter_age

plot_scatter_sex <- data_mlogit %>% 
  filter(!is.na(sex_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = massgebendesEinkommen_imputed, y = anz_teilnahme)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth() +
  facet_wrap(~ sex_c) +
  theme_minimal()
plot_scatter_sex


```

### Multinomial Logit Model
Was ist der Unterschied zwischen mlogit() und multinom()? Weshalb funktioniert mlogit() nicht und multinom() schon?

H1.1A/B

```{r message=FALSE, warning=FALSE}
# library(mlogit)
#
# # Generating the Person-Choice Matrix
# data_mlogitprep <- as.data.frame(data_mlogit) %>% 
#   select(vote_type, alter_c, sex_c, konfession_c, residenz10, zugezogen, mEinkommen_c, Vermoegen_c) %>% 
#   na.omit()
# data_mlogit.pc <- mlogit.data(data_mlogitprep,
#                               varying = 2:8,
#                               choice = "vote_type",
#                               shape = "wide",
#                               sep = "_")
# head(data_mlogit.pc)
# 
# mlogit.fit <- mlogit(vote_type ~ 0 | alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
#                           shape = "long",
#                           data = data_mlogit.pc)

library(nnet)
library(stargazer)
mlogit <- multinom(vote_type ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = data_mlogit)
stargazer(mlogit, type = "text")
```


```{r message=FALSE, warning=FALSE}
mlogit_det <- multinom(vote_type_det ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = data_mlogit15)
stargazer(mlogit_det, type = "text")
```

### Effect of age on political participation for different income quartiles

H2

```{r message=FALSE, warning=FALSE}
plot_scatter_ageincome <- data_mlogit %>% 
  filter(!is.na(mEinkommen_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = alter_v, y = anz_teilnahme)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth() +
  facet_wrap(~ mEinkommen_c) +
  theme_minimal()
plot_scatter_ageincome


plot_scatter_agevermoegen <- data_mlogit %>% 
  filter(!is.na(mEinkommen_c)) %>% 
  mutate(massgebendesEinkommen_imputed = case_when(
    massgebendesEinkommen_imputed < 0 ~ 0,
    TRUE ~ massgebendesEinkommen_imputed
  )) %>% 
  ggplot(aes(x = alter_v, y = anz_teilnahme)) +
  # geom_point() +
  # geom_jitter() +
  geom_smooth() +
  facet_wrap(~ Vermoegen_c) +
  theme_minimal()
plot_scatter_agevermoegen


plot_scatter_age
```

### Effect of jumps in income/wealth

H3A/B

Identify the jumps

->Since we only have income per year -->participation as share (sum(partic)/sum(all_votes))
-->then look for jumps in yearly income
-->compare share of participation before and after


Possible distinctions:
1)	From no income to some income
2)	From some income to no income
3)	From some income to less than 50% of that income
4)	From some income to less than 75% of that income

TODO: Do you have a recommendation for defining jumps of income/wealth? And should I address it seperately in the paper?

```{r message=FALSE, warning=FALSE}
library(data.table) 

# TODO: write function to just specify income/wealth and the wanted distinction of jumps

# get aggregated data by year for respondents
data_year <- data %>% 
  mutate(anz_teilnahme = case_when(
    beteiligt == "mit Stimmbeteiligung" ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(anz_abstimmungen = case_when(
    beteiligt == "mit Stimmbeteiligung" ~ 1,
    beteiligt == "keine Stimmbeteiligung" ~ 1
  )) %>% 
  group_by(id_ek, abstimmungsjahr) %>%
  summarise(anz_teilnahme = sum(anz_teilnahme),
            anz_abstimmungen = sum(anz_abstimmungen),
            share_teilnahme = anz_teilnahme/anz_abstimmungen,
            sex = last(sex_imp),
            alter = mean(alter_v, na.rm=TRUE),
            konfession = last(konfession_imp),
            residenz = mean(residenz_imp, na.rm=TRUE),
            zugezogen = last(zugezogen),
            einkommen = mean(massgebendesEinkommen_imputed, na.rm=TRUE),
            vermoegen = mean(reinvermoegen_imputed, na.rm=TRUE)
            ) %>% 
  distinct() %>% 
  ungroup() 

# Identify individuals with bigger changes in income or wealth
data_year <- data_year %>% 
  group_by(id_ek) %>% 
  # calculate change compared to previous year
  mutate(change_eink = 100 * (einkommen - lag(einkommen, default = NA))/lag(einkommen, default = NA)) %>% 
  mutate(change_verm = 100 * (vermoegen - lag(vermoegen, default = NA))/lag(vermoegen, default = NA)) %>% 
  # Identify big changes in income/wealth
  # TODO: when is change considered to be big? (after 50% change?)
  mutate(bigchange_eink50 = case_when(
    change_eink >= 20 ~ 5,
    change_eink >= 50 ~ 1,
    change_eink <= -50 ~ 2,
    TRUE ~ 0
  )) %>% 
  mutate(bigchange_verm50 = case_when(
    change_verm >= 20 ~ 5,
    change_verm >= 50 ~ 1,
    change_verm <= -50 ~ 2,
    TRUE ~ 0
  )) %>% 
  mutate(bigchange_eink75 = case_when(
    change_eink >= 20 ~ 5,
    change_eink >= 50 ~ 1,
    change_eink <= -75 ~ 3,
    TRUE ~ 0
  )) %>% 
  mutate(bigchange_verm75 = case_when(
    change_verm >= 20 ~ 5,
    change_verm >= 50 ~ 1,
    change_verm <= -75 ~ 3,
    TRUE ~ 0
  )) %>% 
  # create variable to detect individuals with treatment (i.e. big income drop)
  # Only valid when also wealth dropped (otherwise just income shift)
  mutate(treat_less50income = case_when(
    bigchange_eink50 == 2 & bigchange_verm50 %in% c(0, 5) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less50wealth = case_when(
    bigchange_verm50 == 2 & bigchange_eink50 %in% c(0, 5) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less75income = case_when(
    bigchange_eink75 == 3 & bigchange_verm75 %in% c(0, 5) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less75wealth = case_when(
    bigchange_verm75 == 3 & bigchange_eink75 %in% c(0, 5) ~ 1,
    TRUE ~ 0
  )) 


data_year <- data_year %>%
  # for multiple income/wealth shocks only take first one
  group_by(id_ek) %>%
  mutate(inc_change50 = as.numeric(rle(treat_less50income)$lengths %>% {rep(seq(length(.)), .)})) %>% 
  mutate(wealth_change50 = as.numeric(rle(treat_less50wealth)$lengths %>% {rep(seq(length(.)), .)})) %>% 
  mutate(inc_change75 = as.numeric(rle(treat_less75income)$lengths %>% {rep(seq(length(.)), .)})) %>% 
  mutate(wealth_change75 = as.numeric(rle(treat_less75wealth)$lengths %>% {rep(seq(length(.)), .)})) %>%
  ungroup() %>% 
  mutate(inc_change50 = case_when(
    inc_change50 > 2 ~ 3,
    TRUE ~ inc_change50
  )) %>% 
  mutate(wealth_change50 = case_when(
    wealth_change50 > 2 ~ 3,
    TRUE ~ wealth_change50
  )) %>% 
  mutate(treatment_year_inc50 = case_when(
    inc_change50 == 2 ~ abstimmungsjahr,
    TRUE ~ NA_integer_
  )) %>% 
  mutate(treatment_year_wealth50 = case_when(
    wealth_change50 == 2 ~ abstimmungsjahr,
    TRUE ~ NA_integer_
  )) %>% 
  mutate(inc_change75 = case_when(
    inc_change75 > 3 ~ 3,
    TRUE ~ inc_change75
  )) %>% 
  mutate(wealth_change75 = case_when(
    wealth_change75 > 3 ~ 3,
    TRUE ~ wealth_change75
  )) %>% 
  mutate(treatment_year_inc75 = case_when(
    inc_change75 == 3 ~ abstimmungsjahr,
    TRUE ~ NA_integer_
  )) %>% 
  mutate(treatment_year_wealth75 = case_when(
    wealth_change75 == 3 ~ abstimmungsjahr,
    TRUE ~ NA_integer_
  )) %>% 
  group_by(id_ek) %>% 
  fill(treatment_year_inc50, .direction = "updown") %>% 
  fill(treatment_year_wealth50, .direction = "updown") %>% 
  fill(treatment_year_inc75, .direction = "updown") %>% 
  fill(treatment_year_wealth75, .direction = "updown") %>% 
  mutate(treat_less50income = case_when(
    !is.na(treatment_year_inc50) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less50wealth = case_when(
    !is.na(treatment_year_wealth50) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less75income = case_when(
    !is.na(treatment_year_inc75) ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(treat_less75wealth = case_when(
    !is.na(treatment_year_wealth75) ~ 1,
    TRUE ~ 0
  )) %>% 
  # create var years from/to treatment. For the never-treated (i.e. control) units,
  # we'll set the "time_to_treatment" value at 0 for the middle year.
  mutate(treatment_year_inc50 = 
           ifelse(is.na(treatment_year_inc50), round(mean(abstimmungsjahr)), treatment_year_inc50)) %>% 
  mutate(treatment_year_wealth50 = 
           ifelse(is.na(treatment_year_wealth50), round(mean(abstimmungsjahr)), treatment_year_wealth50)) %>% 
  mutate(time_to_treat_inc50 = ifelse(treat_less50income == 1, (abstimmungsjahr - treatment_year_inc50), 0)) %>% 
  mutate(time_to_treat_wealth50 = ifelse(treat_less50wealth == 1, (abstimmungsjahr - treatment_year_wealth50), 0)) %>% 
  mutate(treatment_year_inc75 = 
           ifelse(is.na(treatment_year_inc75), round(mean(abstimmungsjahr)), treatment_year_inc75)) %>% 
  mutate(treatment_year_wealth75 = 
           ifelse(is.na(treatment_year_wealth75), round(mean(abstimmungsjahr)), treatment_year_wealth75)) %>% 
  mutate(time_to_treat_inc75 = ifelse(treat_less75income == 1, (abstimmungsjahr - treatment_year_inc75), 0)) %>% 
  mutate(time_to_treat_wealth75 = ifelse(treat_less75wealth == 1, (abstimmungsjahr - treatment_year_wealth75), 0))
  

```


### Difference-in-Differences Event Study 
Help: https://lost-stats.github.io/Model_Estimation/Research_Design/event_study.html



```{r message=FALSE, warning=FALSE}
library(fixest) 
# TODO: do I need to account for all control variables in the diff-in-diff model? 
# -->how should I handle the categorical ones?

# income shocks
mod_twfe = feols(share_teilnahme ~ i(time_to_treat_inc50, treat_less50income, ref = -1) + ## key interaction: time × treatment status
		  alter + einkommen |               ## Other controls
		  id_ek + abstimmungsjahr,                  ## FEs
		 cluster = ~id_ek,                          ## Clustered SEs
		 data = data_year)


iplot(mod_twfe, 
      xlab = 'Time to treatment',
      main = 'Event-Study of the Effects of Neg. Income Shocks on Voter Turnout (TWFE)')


# wealth shocks
mod_twfe2 = feols(share_teilnahme ~ i(time_to_treat_wealth50, treat_less50income, ref = -1) + ## key interaction: time × treatment status
		  alter + vermoegen |               ## Other controls
		  id_ek + abstimmungsjahr,                  ## FEs
		 cluster = ~id_ek,                          ## Clustered SEs
		 data = data_year)


iplot(mod_twfe2, 
      xlab = 'Time to treatment',
      main = 'Event-Study of the Effects of Neg. Wealth Shocks on Voter Turnout (TWFE)')


# income shocks
mod_twfe = feols(share_teilnahme ~ i(time_to_treat_inc75, treat_less75income, ref = -1) + ## key interaction: time × treatment status
		  alter + einkommen |               ## Other controls
		  id_ek + abstimmungsjahr,                  ## FEs
		 cluster = ~id_ek,                          ## Clustered SEs
		 data = data_year)


iplot(mod_twfe, 
      xlab = 'Time to treatment',
      main = 'Event-Study of the Effects of Neg. Income (-75%) Shocks on Voter Turnout (TWFE)')


# wealth shocks
mod_twfe2 = feols(share_teilnahme ~ i(time_to_treat_wealth75, treat_less75income, ref = -1) + ## key interaction: time × treatment status
		  alter + vermoegen |               ## Other controls
		  id_ek + abstimmungsjahr,                  ## FEs
		 cluster = ~id_ek,                          ## Clustered SEs
		 data = data_year)


iplot(mod_twfe2, 
      xlab = 'Time to treatment',
      main = 'Event-Study of the Effects of Neg. Wealth (-75%) Shocks on Voter Turnout (TWFE)')
```



The effect of income is very different depending on the age category!




```{r message=FALSE, warning=FALSE}
plot_scatter_sex
```


### Je geringer die empfundene Relevanz einer Abstimmung ist, desto groesser ist die Rolle, welche das Einkommen bei der Beteiligung am Urnengang spielt. 

TODO: Is there a better method to compare the effect of the independent on the dependent variable than just subsetting the group and looking at the estimates?

```{r message=FALSE, warning=FALSE}
votes <- read.csv("/Users/alinelaurametzler/Documents/Universität/Master/Master Thesis/MA-Code/Data/PreparedData/votes_data_short.csv", encoding = "UTF-8")

# select votes with low/high importance (i.e. lowest/highest quartile of importance)
votes_lowimp <- votes %>% 
  filter(quantile(importance, 0.25) >= importance) %>% 
  select(datum, titel_kurz_d, jour, mois, annee, importance)
votes_highimp <- votes %>% 
  filter(quantile(importance, 0.75) <= importance) %>% 
  select(datum, titel_kurz_d, jour, mois, annee, importance)

# join with admin. data
turnout_lowimp <- votes_lowimp %>% 
  left_join(data, by = "datum")
turnout_highimp <- votes_highimp %>% 
  left_join(data, by = "datum")


# multinomial logit model
mlogit_lowimp <- multinom(beteiligt ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = turnout_lowimp)
mlogit_highimp <- multinom(beteiligt ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = turnout_highimp)

stargazer(mlogit_lowimp, mlogit_highimp, type = "text")
```

### Bei Abstimmungen mit einem grösseren Umverteilungsaspekt spielt das Einkommen eine grössere Rolle bei der Beteiligung am Urnengang.


```{r message=FALSE, warning=FALSE}


# 10.2	Sozialversicherungen
# 6.1	Steuerwesen

votes_umverteilung <- votes %>% 
  filter(d1e2 %in% c(6.1, 10.2))

votes_steuern <- votes %>% 
  filter(d1e2 == 6.1)


# join with admin. data
turnout_umverteilung<- votes_umverteilung %>% 
  left_join(data, by = "datum")
turnout_steuern <- votes_steuern %>% 
  left_join(data, by = "datum")


# multinomial logit model
mlogit_umverteilung <- multinom(beteiligt ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = turnout_umverteilung)
mlogit_steuern <- multinom(beteiligt ~ alter_c + sex_c + konfession_c + residenz10 + zugezogen + mEinkommen_c + Vermoegen_c,
                   data = turnout_steuern)

stargazer(mlogit_umverteilung, mlogit_steuern, type = "text")
```

### Der Effekt von hohem Einkommen überträgt sich auch auf die Beteiligung am Urnengang anderer Personen, welche im selben Haushalt leben.


Compare households with high income/wealth to households with low income wealth

Compare highest earning person of household to other members that have less income/wealth
-->Especially look at adult children that still live with parents


```{r message=FALSE, warning=FALSE}
# TODO: can I just  define children by their age group (18-25) living with older age group (35-65)?
# -->what about couples, shared flats with bigger age gaps? (right now I just ignore this)
data_households <- data %>% 
  ungroup() %>% 
  filter(haushalttyp_sw_2 == "Mehrpersonenhaushalte") %>% 
  filter(generationen_sw %in% c("Zwei Generationen", "Drei Generationen", "Vier Generationen")) %>% 
  mutate(young_pers = case_when(
    alter_v <= 25 ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(older_pers = case_when(
    alter_v > 35 & alter_v <= 65 ~ 1,
    TRUE ~ 0
  )) %>% 
  group_by(householdID_sw) %>% 
  # all housholds (mind. 2 generations) with young people and older people in them
  filter(sum(young_pers) >= 1 & sum(older_pers) >= 1) %>% 
  # create variable to sum income of parents (=older_pers in household)
  group_by(householdID_sw, older_pers) %>% 
  mutate(income_older = case_when(
    # married couples have joined incomes
    steuer_tarif_imputed == "verheiratet" & older_pers == 1 ~ massgebendesEinkommen_imputed,
    steuer_tarif_imputed == "alleinstehend/unverheiratet" & older_pers == 1 ~ sum(massgebendesEinkommen_imputed) ,
    TRUE ~ NA_real_
  )) %>% 
  ungroup() %>% 
  group_by(householdID_sw) %>% 
  fill(income_older, .direction = "updown") %>% 
  filter(young_pers == 1) %>% 
  ungroup() %>% 
  filter(!is.na(income_older)) %>% 
  # take one random vote date per individual
  group_by(id_ek) %>%
  sample_n(1)


# households with low income of parents
data_households_low <- data_households %>% 
  ungroup() %>% 
  filter(quantile(income_older, 0.25) >= income_older) 

mlogit_household_low <- multinom(beteiligt ~  alter_c + sex_c + konfession_c + residenz10 + zugezogen + income_older+ mEinkommen_c + Vermoegen_c,
                   data = data_households_low)



# households with high income of parents
data_households_high <- data_households %>% 
  filter(quantile(income_older, 0.75) <= income_older) 

mlogit_household_high <- multinom(beteiligt ~  alter_c + sex_c + konfession_c + residenz10 + zugezogen + income_older + mEinkommen_c + Vermoegen_c,
                   data = data_households_high)

stargazer(mlogit_household_low, mlogit_household_high, type = "text")

```



